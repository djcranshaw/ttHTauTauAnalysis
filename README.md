# ttHTauTauAnalysis

## Installation

Setup CMSSW environment:

	cmsrel CMSSW_9_4_4
	cd CMSSW_9_4_4/src/
	cmsenv
	git cms-init

Electron MVA ID:

	git cms-merge-topic guitargeek:ElectronID_MVA2017_940pre3

Get Analyzer:

	git clone https://github.com/zctao/ttHTauTauAnalysis.git
	cd ttHTauTauAnalysis
	git checkout cmssw_9_4_x
	cd -

Add MVA package if necessary:

	git clone https://github.com/zctao/ttHTauTauMVA.git

Add MEM interface if necessary:

	git clone https://github.com/zctao/ttHTauTau_MEM_Interface.git

MiniAODHelper:

	git clone https://github.com/cms-ttH/MiniAOD.git
	(currently use branch cmssw940pre3)

LeptonID package shared with ND ttH-Multilepton group:

	git clone https://github.com/zctao/ttH-LeptonID.git ttH/LeptonID
	cd ttH/LeptonID
	git checkout cmssw_944_sync
	cd -

Compile:

	scram b -j 32

Add the area containing the Electron MVA weights:

	cd $CMSSW_BASE/external
	cd slc6_amd64_gcc630/
	git clone https://github.com/lsoffi/RecoEgamma-PhotonIdentification.git data/RecoEgamma/PhotonIdentification/data
	cd data/RecoEgamma/PhotonIdentification/data
	git checkout CMSSW_9_4_0_pre3_TnP
	cd $CMSSW_BASE/external
	cd slc6_amd64_gcc630/
	git clone https://github.com/lsoffi/RecoEgamma-ElectronIdentification.git data/RecoEgamma/ElectronIdentification/data
	cd data/RecoEgamma/ElectronIdentification/data
	git checkout CMSSW_9_4_0_pre3_TnP
	cd $CMSSW_BASE/src

Get data files before running analyzer:

	cd ttHTauTauAnalysis/ttHtautauAnalyzer/data
	./fetchDataFiles.sh
	cd -

When running with CRAB one needs to add the following option to the crab config file: config.JobType.sendExternalFolder = True This is needed until the PR including this ID will be integrated in CMSSW/cms-data.

## Usage

Produce sync ntuples:

	./ttHtautauAnalyzer/test/produceSyncNtuples.sh

Submit CRAB jobs to produce event ntuples:
	   
	submitCrabJobs.py <samplelist> <analysis_type> <selection_type> --channel_list <channel_list> --prefix <prefix>
	
	submitCrabJobs.py -h for help

Collect and hadd CRAB outputs on EOS:

	haddCrabOutputs.sh <analysis_type> <samplelist> <eostopdir> <version> <prefix> <ntuplelist> <output_name> <list of samples to be added>

It would also generate something like 'ntuplelist.log' file to store the location of the output ntuples. Two examples of using haddCrabOutputs.sh script are in ttHtautauAnalyzer/test/: haddCrabOutputFastSim2016.sh and haddCrabOutputMoriond2017.sh

Make flat mvaNtuple from event ntuple:

	 produceMVANtuples.py <analysis_type> <list of sample names> -l <ntuplelist>

	 produceMVANtuples.py -h for help

This python script is a wrapper of binary 'makeMVANtuple' that does the actual production of mva ntuples. The python script picks the right ntuple file name based on the ntuplelist generated by hadd scripts. It also generates a list 'mvaNtuples.txt' of mva ntuples it produced.

Make data cards using flat mvaNtuples:

	 makeDatacards.py <analysis_type> <list of channels included in datacards> <number of bins> -n <mvaNtupleList> -b <binningMap>

	 makeDatacards.py -h for help